---
layout: default
title: Register Attendees
description: Setup a REST endpoint that accepts attendees' registration
lang: en
parent: Advanced Message Queuing Protocol
nav_order: 5
permalink: docs/amqp/register/
---

# Register Attendees
{: .no_toc }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Objectives

We need to add a new REST endpoint, `/event/{event-id}/register`, that accepts POST requests to register attendees.  The event id, in the form of [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier), will be part of the path, as shown next.

```
/event/47705b9b-518b-4dc2-a517-3dbbcab13fe7/register
```

The POST request will also have a body similar to the following example.

{% include custom/note.html details="The event id is not part of the request body, but only part of the request endpoint." %}

```json
{
  "name": "Aden Attard",
  "foodPreference": "VEGETARIAN"
}
```

In the above example, _Aden Attard_ submitted his registration for the event with id `47705b9b-518b-4dc2-a517-3dbbcab13fe7` and picked `VEGETARIAN` as his food of choice.

Following is a complete example of a request, using [CURL](https://curl.haxx.se/), that can be made to the REST endpoint **once this is created**.

```bash
$ curl \
 -H "content-type:application/json" \
 -X POST -d'{"name":"Aden Attard","foodPreference":"VEGETARIAN"}' \
 http://localhost:8080/event/47705b9b-518b-4dc2-a517-3dbbcab13fe7/register
```

The attendee should either receive a [404](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/404), meaning that the registration failed as the event does not exist or has expired.  If the registration succeeds, then the attendee should receive the registration id, similar to the following example.

```json
{
  "id": "248ed31c-35e3-4bd8-a36e-a5c27d3eb999"
}
```

The registration id is another UUID which is generated by the registration process.

**Objectives**

- [ ] Attendees cannot register to an event that does not exist
- [ ] Attendees cannot register to an expired event (event that happened in the past)
- [ ] Attendees should receive a confirmation following a successful registration

## Controller

We will start from the frontend, the controller, and we will work our way back.

1. Create new `event` package

   ```bash
   $ mkdir src/main/java/demo/boot/event
   $ mkdir src/test/java/demo/boot/event
   $ mkdir src/test-integration/java/demo/boot/event
   ```

1. Create the controller

   Create file: `src/main/java/demo/boot/event/EventRegistrationController.java`

   ```java
   package demo.boot.event;

   import org.springframework.web.bind.annotation.RestController;

   @RestController
   public class EventRegistrationController {

   }
   ```

1. Create the controller test

   Create file: `src/test/java/demo/boot/event/EventRegistrationControllerTest.java`

   ```java
   package demo.boot.event;

   import org.junit.jupiter.api.DisplayName;
   import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;

   @DisplayName( "Registration controller" )
   @WebMvcTest( EventRegistrationController.class )
   public class EventRegistrationControllerTest {

   }
   ```

1. Test for registration for an event that does not exist

   Update file: `src/test/java/demo/boot/event/EventRegistrationControllerTest.java`

   {% include custom/dose_not_compile.html %}

   ```java
   package demo.boot.event;

   import com.fasterxml.jackson.databind.ObjectMapper;
   import org.junit.jupiter.api.DisplayName;
   import org.junit.jupiter.api.Test;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
   import org.springframework.boot.test.mock.mockito.MockBean;
   import org.springframework.http.MediaType;
   import org.springframework.test.web.servlet.MockMvc;

   import java.nio.charset.StandardCharsets;
   import java.util.Optional;
   import java.util.UUID;

   import static org.mockito.ArgumentMatchers.eq;
   import static org.mockito.Mockito.times;
   import static org.mockito.Mockito.verify;
   import static org.mockito.Mockito.verifyNoMoreInteractions;
   import static org.mockito.Mockito.when;
   import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
   import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

   @DisplayName( "Registration controller" )
   @WebMvcTest( EventRegistrationController.class )
   public class EventRegistrationControllerTest {

     @Autowired
     private MockMvc mockMvc;

     @MockBean
     private EventRegistrationService service;

     @Autowired
     private ObjectMapper jsonObjectMapper;

     @Test
     @DisplayName( "should return not found when registering for an event that does not exists" )
     public void shouldReturnNotFound() throws Exception {
       final UUID eventId = UUID.randomUUID();
       final String name = "Aden Attard";
       final FoodPreference foodPreference = FoodPreference.MEAT;
       final RegistrationRequest registrationRequest = new RegistrationRequest( name, foodPreference );
       final RegistrationDetails details = new RegistrationDetails( eventId, name, foodPreference );

       when( service.register( eq( details ) ) ).thenReturn( Optional.empty() );

       mockMvc
         .perform(
           post( "/event/{eventId}/register", eventId )
             .contentType( MediaType.APPLICATION_JSON )
             .characterEncoding( StandardCharsets.UTF_8.displayName() )
             .content( jsonObjectMapper.writeValueAsString( registrationRequest ) )
         )
         .andExpect( status().isNotFound() )
       ;

       verify( service, times( 1 ) ).register( details );
       verifyNoMoreInteractions( service );
     }
   }
   ```

   Make the test compile.

   1. Create file: `src/main/java/demo/boot/event/FoodPreference.java`

      ```java
      package demo.boot.event;

      public enum FoodPreference {
        NO_FOOD,
        VEGETARIAN,
        VEGAN,
        MEAT
      }
      ```

   1. Create file: `src/main/java/demo/boot/event/RegistrationDetails.java`

      ```java
      package demo.boot.event;

      import lombok.AllArgsConstructor;
      import lombok.Data;
      import lombok.NoArgsConstructor;

      import java.util.UUID;

      @Data
      @NoArgsConstructor
      @AllArgsConstructor
      public class RegistrationDetails {

        private UUID eventId;
        private String name;
        private FoodPreference foodPreference;
      }
      ```

   1. Create file: `src/main/java/demo/boot/event/RegistrationConfirmation.java`

      ```java
      package demo.boot.event;

      import lombok.AllArgsConstructor;
      import lombok.Data;
      import lombok.NoArgsConstructor;

      import java.util.UUID;

      @Data
      @NoArgsConstructor
      @AllArgsConstructor
      public class RegistrationConfirmation {

        private UUID id;
      }
      ```

   1. Create file: `src/main/java/demo/boot/event/EventRegistrationService.java`

      ```java
      package demo.boot.event;

      import java.util.Optional;

      public class EventRegistrationService {

        public Optional<RegistrationConfirmation> register( final RegistrationDetails registration ) {
          return Optional.empty();
        }
      }
      ```

   1. Create file: `src/main/java/demo/boot/event/RegistrationRequest.java`

      ```java
      package demo.boot.event;

      import lombok.AllArgsConstructor;
      import lombok.Data;
      import lombok.NoArgsConstructor;

      @Data
      @NoArgsConstructor
      @AllArgsConstructor
      public class RegistrationRequest {

        private String name;
        private FoodPreference foodPreference;
      }
      ```

   The test should not compile.  Run the test.

   ```bash
   $ ./gradlew clean test

   ...

   Registration controller > should return not found when registering for an event that does not exists FAILED
       org.mockito.exceptions.verification.WantedButNotInvoked at EventRegistrationControllerTest.java:58

   ...

   BUILD FAILED in 9s
   5 actionable tasks: 5 executed
   ```

   The test will fail, as expected.

   {% include custom/note.html details="The test had received a 404, as expected but the controller did not interact with the mocks as expected" %}

   ```bash
   $ open "build/reports/tests/test/classes/demo.boot.event.EventRegistrationControllerTest.html"
   ```

   ![Event-Registration-Controller-Test-shouldReturnNotFound.png]({{ '/assets/images/Event-Registration-Controller-Test-shouldReturnNotFound.png' | absolute_url }})

1. Make the test pass

   Update file: `src/main/java/demo/boot/event/EventRegistrationController.java`

   ```java
   package demo.boot.event;

   import lombok.AllArgsConstructor;
   import org.springframework.http.ResponseEntity;
   import org.springframework.web.bind.annotation.PathVariable;
   import org.springframework.web.bind.annotation.PostMapping;
   import org.springframework.web.bind.annotation.RequestBody;
   import org.springframework.web.bind.annotation.RestController;

   import java.util.UUID;

   @RestController
   @AllArgsConstructor
   public class EventRegistrationController {

     private final EventRegistrationService service;

     @PostMapping( "/event/{eventId}/register" )
     public ResponseEntity<RegistrationConfirmation> register(
       @PathVariable( "eventId" ) final UUID eventId,
       @RequestBody final RegistrationRequest request
     ) {
       final RegistrationDetails details =
         new RegistrationDetails( eventId, request.getName(), request.getFoodPreference() );

       service.register( details );
       return ResponseEntity.notFound().build();
     }
   }
   ```

   Run the tests.

   ```bash
   $ ./gradlew clean test

   ...

   BUILD SUCCESSFUL in 7s
   5 actionable tasks: 5 executed
   ```

   All tests should now pass.
